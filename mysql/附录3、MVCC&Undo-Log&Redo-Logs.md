# MVCC&Undo-Log&Redo-Logs

## MVCC

DB_TRX_ID最新更新的事务id、DB_ROLL_PTR指向回滚段的指针、DB_ROW_ID行id

insert undo logs 事务提交就可以丢弃

update undo logs 没有事务在一致性读中需要用到该快照来构建早期版本的数据库记录时，该回滚段才可以被丢弃，我的理解就是当前活跃的事务的事务id都大于该回滚段中记录的最新更新的事务id

推荐经常提交事务，包括一致性读事务，否则InnoDB无法丢弃回滚段，回滚段就会变得越来越大。无论从回滚段的空间大小还是并发性能考虑，都要减少或不出现大事务

当行记录被删除时，InnoDB不会立即物理删除行记录和它的索引，只有当删除语句相应的回滚段被丢弃，才会做物理删除，这个删除的操作叫清除，它相当快，通常，按时间顺序与删除的SQL语句相同

MVCC对待聚簇索引和二级索引是不同的，聚簇索引包含DB_TRX_ID、DB_ROLL_PTR、DB_ROW_ID系统隐藏字段，因此做原地更新；而二级索引不包含系统隐藏字段，因此将原记录标记为删除，并新增一个索引记录。当一个二级索引被标记为删除或者被更新，回去聚簇索引检索正确版本的数据，此时不会使用覆盖索引技术，而索引下推任然是支持的。



## Undo Log



## Redo Logs

