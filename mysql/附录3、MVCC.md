# MVCC

**DB_TRX_ID**: 最新更新的事务id。

**DB_ROLL_PTR**: 指向回滚段的指针。

**DB_ROW_ID**: 行id。

insert undo logs在事务提交之后就可以被丢弃；update undo logs在没有事务在一致性读中需要用到该快照来构建早期版本的数据库记录时，该回滚段才可以被丢弃，即没有被ReadView引用。

推荐经常提交事务，包括一致性读事务，否则InnoDB无法丢弃回滚段，回滚段就会变得越来越大。无论从回滚段的空间大小还是并发性能考虑，都要减少或不出现大事务

当行记录被删除时，InnoDB不会立即物理删除行记录和它的索引，只有当删除语句相应的回滚段被丢弃，才会做物理删除，这个删除的操作叫清除，它相当快，通常，按时间顺序与删除的SQL语句相同

MVCC对待聚簇索引和二级索引是不同的，聚簇索引包含DB_TRX_ID、DB_ROLL_PTR、DB_ROW_ID系统隐藏字段，因此做原地更新；而二级索引不包含系统隐藏字段，因此将原记录标记为删除，并新增一个索引记录。当一个二级索引被标记为删除或者被更新，会去聚簇索引检索正确版本的数据，此时不会使用覆盖索引技术，而索引下推任然是支持的。



# ReadView

**up_limit_id**: 当前最早创建的活跃事务。

**low_limit_id**: 当前除自身外最晚创建的活跃事务。

**m_ids**: 当前活跃的事务ID集合。

**DB_TRX_ID**: 最后修改这条数据的事务的ID。

- 如果DB_TRX_ID  < up_limit_id，表示这条数据的最后修改在ReadView创建之前，所以这条数据是可见的；

- 如果DB_TRX_ID  > low_limit_id，表示这条数据的最后修改在ReadView创建之后，所以这条数据是不可见的；

- 如果DB_TRX_ID在up_limit_id和low_limit_id之间，则看m_ids集合中是否存在DB_TRX_ID:

  - 如果存在，表示这条记录的最后修改在ReadView创建之时，所以这条数据是不可见的；

  - 如果不存在，表示这条记录的最后修改在ReadView创建之前，所以这条数据是可见的。

